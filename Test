package eu.olkypay.bankInfo.web;

import eu.olkypay.bankInfo.dto.BankInfoDTO;

import eu.olkypay.bankInfo.dto.BicValidationResponse;
import eu.olkypay.bankInfo.dto.IbanInfoUtilsDTO;
import eu.olkypay.bankInfo.dto.IbanSearchHistoryDTO;
import eu.olkypay.bankInfo.service.BankInfoValidationService;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.media.ArraySchema;
import io.swagger.v3.oas.annotations.media.Content;
import io.swagger.v3.oas.annotations.media.Schema;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Optional;

@RestController
@RequestMapping("/api/")
@Tag(name = "Bank Info", description = "Bank Info Validation")
public class BankInfoValidationController {

    private final BankInfoValidationService bankInfoValidationService;

    public BankInfoValidationController(BankInfoValidationService bankInfoValidationService) {
        this.bankInfoValidationService = bankInfoValidationService;
    }

    @Operation(summary = "Validate Iban")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "200", description = "Validation completed",
                    content = @Content(array = @ArraySchema(schema = @Schema(implementation = IbanSearchHistoryDTO.class)))),
            @ApiResponse(responseCode = "401", description = "Forbidden", content = @Content)
    })
    @PostMapping("/validate/{iban}")
    public Optional<IbanSearchHistoryDTO> validateIban(@PathVariable String iban) {
        return bankInfoValidationService.validateIban(iban);
    }

    @Operation(summary = "find bank by bic")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "200", description = "Validation completed",
                    content = @Content(array = @ArraySchema(schema = @Schema(implementation = BankInfoDTO.class)))),
            @ApiResponse(responseCode = "401", description = "Forbidden", content = @Content)
    })
    @GetMapping("/bic/{bic}")
    public BankInfoDTO getBankInfoByBic(@PathVariable String bic) {
        return bankInfoValidationService.findBankByBic(bic).get();
    }

    @Operation(summary = "Validate BIC format only")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "200", description = "BIC validation result",
                    content = @Content(schema = @Schema(implementation = BicValidationResponse.class)))
    })
    @PostMapping("/validate/bic/{bic}")
    public ResponseEntity<BicValidationResponse> validateBic(@PathVariable String bic) {
        BicValidationResponse response = bankInfoValidationService.validateBic(bic);
        return ResponseEntity.ok(response);
    }

    @Operation(summary = "Validate BIC and IBAN")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "200", description = "BIC validation result",
                    content = @Content(schema = @Schema(implementation = BicValidationResponse.class)))
    })
    @PostMapping("/validate/{bic}/{iban}")
    public ResponseEntity<BicValidationResponse> validateIBANBIC(@RequestBody IbanInfoUtilsDTO ibanInfo, @PathVariable String bic, @PathVariable String iban) {
        BicValidationResponse response = bankInfoValidationService.validateIbanAndBic(iban, bic, ibanInfo);
        return ResponseEntity.ok(response);
    }

    @Operation(summary = "Validate BIC and IBAN")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "200", description = "BIC validation result",
                    content = @Content(schema = @Schema(implementation = BicValidationResponse.class)))
    })
    @PostMapping("/deriveBICFromIBAN/{iban}")
    public ResponseEntity<BicValidationResponse> deriveBICFromIBAN(@PathVariable String iban) {
        BicValidationResponse response = bankInfoValidationService.getBicFromIban(iban);
        return ResponseEntity.ok(response);
    }

}
this is my controller for my api : {{host}}/validate/SPKHDE2H/DE43250501800000198080
i have this :

{
  "timestamp": "2025-11-17T10:15:40.254+00:00",
  "status": 401,
  "error": "Unauthorized",
  "message": "Unauthorized",
  "path": "/api/validate/SPKHDE2H/DE43250501800000198080"
}
