Parfait â€” Spring Boot 3 + 1 API Key par application, câ€™est un excellent choix âœ…
Je te donne une solution PRO, rapide, sÃ©curisÃ©e et ultra simple, prÃªte Ã  copier-coller.

Objectif :
âœ… Plus de Basic Auth
âœ… Plus de BCrypt
âœ… Plus de 300 ms
âœ… Une API Key par appli
âœ… VÃ©rif en ~2 ms
âœ… Compatible infra / back uniquement

â¸»

âœ… 1. TABLE SQL

create table api_keys (
    id bigserial primary key,
    application_name varchar(100) not null unique,
    api_key varchar(128) not null unique,
    enabled boolean default true,
    created_at timestamp default now()
);


â¸»

âœ… 2. ENTITY

@Entity
@Table(name = "api_keys")
public class ApiKey {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String applicationName;

    @Column(unique = true, nullable = false)
    private String apiKey;

    private boolean enabled = true;

    private LocalDateTime createdAt = LocalDateTime.now();
}


â¸»

âœ… 3. REPOSITORY

public interface ApiKeyRepository extends JpaRepository<ApiKey, Long> {
    Optional<ApiKey> findByApiKeyAndEnabledTrue(String apiKey);
    Optional<ApiKey> findByApplicationName(String applicationName);
}


â¸»

âœ… 4. SERVICE (clÃ© ultra sÃ©curisÃ©e)

@Service
public class ApiKeyService {

    private final ApiKeyRepository repository;

    public ApiKeyService(ApiKeyRepository repository) {
        this.repository = repository;
    }

    public ApiKey generate(String applicationName) {
        return repository.findByApplicationName(applicationName)
                .orElseGet(() -> {
                    ApiKey key = new ApiKey();
                    key.setApplicationName(applicationName);
                    key.setApiKey(UUID.randomUUID().toString().replace("-", "") +
                                  UUID.randomUUID().toString().replace("-", ""));
                    return repository.save(key);
                });
    }

    public boolean isValid(String apiKey) {
        return repository.findByApiKeyAndEnabledTrue(apiKey).isPresent();
    }
}


â¸»

âœ… 5. CONTROLLER POUR CRÃ‰ER LA CLÃ‰ (route infra)

@RestController
@RequestMapping("/internal/api-keys")
public class ApiKeyController {

    private final ApiKeyService service;

    public ApiKeyController(ApiKeyService service) {
        this.service = service;
    }

    @PostMapping("/{appName}")
    public ResponseEntity<ApiKeyResponse> create(@PathVariable String appName) {
        ApiKey key = service.generate(appName);
        return ResponseEntity.ok(new ApiKeyResponse(key.getApiKey()));
    }
}

public record ApiKeyResponse(String apiKey) {}


â¸»

âœ… 6. FILTRE DE SÃ‰CURITÃ‰ (le cÅ“ur du systÃ¨me)

@Component
public class ApiKeyFilter extends OncePerRequestFilter {

    private final ApiKeyService apiKeyService;

    public ApiKeyFilter(ApiKeyService apiKeyService) {
        this.apiKeyService = apiKeyService;
    }

    @Override
    protected void doFilterInternal(
            HttpServletRequest request,
            HttpServletResponse response,
            FilterChain filterChain
    ) throws ServletException, IOException {

        String apiKey = request.getHeader("X-API-KEY");

        if (request.getRequestURI().startsWith("/internal/api-keys")) {
            filterChain.doFilter(request, response);
            return;
        }

        if (apiKey == null || !apiKeyService.isValid(apiKey)) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            response.getWriter().write("Invalid or missing API Key");
            return;
        }

        filterChain.doFilter(request, response);
    }
}


â¸»

âœ… 7. SPRING SECURITY CONFIG (SPRING BOOT 3)

@Configuration
@EnableWebSecurity
public class SecurityConfig {

    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http, ApiKeyFilter apiKeyFilter) throws Exception {
        return http
                .csrf(csrf -> csrf.disable())
                .sessionManagement(sm -> sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
                .authorizeHttpRequests(auth -> auth
                        .requestMatchers("/internal/api-keys/**").permitAll()
                        .anyRequest().authenticated()
                )
                .addFilterBefore(apiKeyFilter, UsernamePasswordAuthenticationFilter.class)
                .build();
    }
}


â¸»

âœ… 8. UTILISATION CÃ”TÃ‰ INFRA

âœ… CrÃ©ation de la clÃ© :

curl -X POST http://bank-info/internal/api-keys/tournesol

RÃ©ponse :

{
  "apiKey": "tournesol_abcd1234....."
}


â¸»

âœ… Utilisation cÃ´tÃ© infra :

GET /bank-info/accounts
X-API-KEY: tournesol_abcd1234.....


â¸»

âœ… 9. PERFORMANCES ATTENDUES

MÃ©thode	Temps
Basic Auth + BCrypt	âŒ 200â€“350 ms
API Key	âœ… 2â€“10 ms


â¸»

âœ… 10. SÃ‰CURITÃ‰ BONUS (RECOMMANDÃ‰ EN PROD)

Tu peux ajouter facilement :

âœ… IP whitelist sur /internal/api-keys
âœ… Expiration de clÃ©
âœ… Rotation automatique
âœ… Logs dâ€™accÃ¨s
âœ… DÃ©sactivation dâ€™une clÃ© Ã  chaud

â¸»

âœ… 11. MIGRATION DEPUIS TON SETUP ACTUEL

1ï¸âƒ£ Supprimer :

UserDetailsService
BCryptPasswordEncoder
Basic Auth config

2ï¸âƒ£ Ajouter :

ApiKeyFilter
ApiKeyService
ApiKeyController

3ï¸âƒ£ Tester :

curl sans clÃ© â†’ 401 âœ…
curl avec clÃ© â†’ 200 âœ…


â¸»

âœ… CONCLUSION

âœ… Ton design est propre, rapide, scalable, sÃ©curisÃ©
âœ… Parfait pour une infra backend
âœ… Plus de latence inutile
âœ… Plus de mots de passe en dur
âœ… Plus de BCrypt

â¸»

ğŸ‘‰ Si tu veux, je peux maintenant :

âœ… Adapter ce code exactement Ã  ton projet
âœ… Ajouter la rotation automatique des clÃ©s
âœ… Ajouter une protection IP sur la route de gÃ©nÃ©ration
âœ… Ou tâ€™Ã©crire les tests unitaires

Dis-moi ce que tu veux ajouter ğŸ”§ğŸš€